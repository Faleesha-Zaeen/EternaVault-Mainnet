name: Deploy Hardhat to QIE Mainnet

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy LegacyVault
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (contracts)
        working-directory: contracts
        run: npm install

      - name: Deploy to QIE Mainnet
        working-directory: contracts
        env:
          QIE_RPC_URL: ${{ secrets.QIE_RPC_URL }}
          QIE_CHAIN_ID: 1990
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        run: |
          set -e
          echo "Deploying LegacyVault to qieMainnet..."
          
          npx hardhat run scripts/deploy.js --network qieMainnet > deploy_output.txt 2>&1 || (cat deploy_output.txt && exit 1)

          echo "===== Raw Deploy Output ====="
          cat deploy_output.txt

          ADDRESS=$(grep -Eo '0x[a-fA-F0-9]{40}' deploy_output.txt | head -n1 || true)

          if [ -n "$ADDRESS" ]; then
            echo ""
            echo "ğŸš€ LegacyVault deployed successfully!"
            echo "ğŸ“Œ Contract Address: $ADDRESS"
            echo ""
          else
            echo "âŒ ERROR: No contract address found"
            exit 1
          fi
